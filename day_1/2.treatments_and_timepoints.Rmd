---
title: "Treatments and timepoints"
author: "Filippo Biscarini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
library("DT")
library("knitr")
library("ggpubr")
library("tidyverse")
library("data.table")

knitr::opts_chunk$set(echo = TRUE)
```

## Treatments and timepoints

$$
y = \mu + \beta_1 \text{timepoint} + \beta_2 \text{treatment} + e
$$

## Read the data

Data from [The effects of lateral line ablation and regeneration in schooling giant danios](https://journals.biologists.com/jeb/article/221/8/jeb175166/300/The-effects-of-lateral-line-ablation-and) (data repo [here](https://zenodo.org/record/4999506))

It's data on fish (*Devario aequipinnatus*) lateral line system, with the effect of chemical treatments (gentamycin or no treatment -- sham) at different timepoints.

```{r read-the-bird-data}
basefolder = "/home/filippo/Dropbox/cursos/longitudinal_data_analysis/longitudinal_data_analysis"
inpfile = "data/lateral_line/JEXBIO-2017-175166-Processed-Data-Master.txt"
fname = file.path(basefolder, inpfile)

danios = fread(fname)
```

Dataset on *giant danios*: how the lateral line system responds to chemical treatments.

The target variables can be:

1.  nearest neighbor distance or NND (unit: body length),
2.  time in school (percentage),
3.  angular bearing (unit: degrees),
4.  angular elevation (unit: degrees),
5.  speed (body length per second).

Explanatory variables include:

-   `Treatment`: gentamycin / sham (control)
-   `Week`: time point in subsequent weeks (from week -1 to week 8)

### EDA

```{r}
danios |>
  group_by(Week, Treatment) |>
  summarise(N = n()) |>
  spread(key = Treatment, value = N) |>
  kable(format = "html", table.attr = "style = \"color: white;\"")
```

```{r, fig.width=12, fig.height=9}
mD <- danios |> gather(key = "target", value = "value", -c(Treatment, Week))
mD$Week <- factor(mD$Week)

df_mean <- mD |> group_by(Week, Treatment, target) |>
  summarise(avg = mean(value))

p <- ggplot(mD, aes(x = Week, y = value)) + geom_boxplot(aes(color = Treatment), alpha = 0.3)
p <- p + geom_point(data = df_mean, mapping = aes(x = Week, y = avg, group=Treatment), color="black")
p <- p + geom_line(data = df_mean, mapping = aes(x = Week, y = avg, group=Treatment, color=Treatment), size = 1.5)
p <- p + facet_wrap(~target, scales = "free_y")
p <- ggpar(p, palette = c("#00AFBB", "#E7B800", "#FC4E07"))
p
```

From reading the article, we expect the treatment to have an effect a little time after the application of gentamycin (vs control/sham) 
and then to see restoration when the cells of the lateral line system are regenerated.

**Q: which target variables better show this expected pattern?**

### Pick target variable

We select `Time in School` (based on the EDA above).

```{r}
dd <- danios |>
  group_by(Week, Treatment) |>
  summarise(avg = mean(`Time in School`), std = sd(`Time in School`))
```

```{r}
temp <- dd |>
  select(-std) |>
  spread(key = Treatment, value = avg) |>
  mutate(diff = abs(Gentamycin-Sham)) |>
  select(-c(Gentamycin,Sham))

dd <- dd |> inner_join(temp, by = "Week")
```

```{r}
datatable(dd, options=list(columnDefs = list(list(visible=FALSE, targets=c(5))),
                           pageLength = 12)) |> 
  # formatStyle('Week', fontWeight = styleInterval(c(2,4), c('normal', 'bold','normal'))) |>
  formatStyle(
    'diff',
    target = 'row',
    fontWeight = styleInterval(c(20), c('normal', 'bold')),
    # color = styleInterval(c(20, 40), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(20, c('white', 'yellow'))
)
```

## Models of analysis

1. treatment within timepoint
2. treatment + timepoint
3. treatment + timepoint + (treatment x timepoint)

### Within timepoint

This is the simplest approach: we split the data by timepoint and make a comparison between treatments.

```{r}
school_time = filter(mD, target == "Time in School") ## !! REMEMBER THAT WE SELECTED ONE TARGET VARIABLE, Time in School !!
school_time$Treatment <- factor(school_time$Treatment, levels = c("Sham", "Gentamycin"))
temp <- filter(school_time, Week == 2)
```

Now we have a much simpler dataset, with `Gentamycin`-treated and control fish records from week 2 only.

$$
\text{Time in School} = \mu + \beta \text{Treatment} + e
$$

```{r}
fit = lm(value ~ Treatment, data = temp)
summary(fit)
```

#### From matrix algebra

$$
\mathbf{y} = \mathbf{Xb} + \mathbf{e}
$$

```{r}
X <- model.matrix(value ~ Treatment, temp)
y = temp$value
```

$$
\mathbf{X'y} = \mathbf{X'Xb}
$$

- **X**: (n,m) = (50, 2) [50 records, 2 parameters: intercept and slope]
- **y**: (n,1)
- **X'y**: (m,1) = (2,1)
- **X'X**: (m,m) = (2,2)
- **b**: (m,1) = (2,1)

```{r}
Xy = t(X) %*% y
XX = t(X) %*% X
```

$$
\mathbf{b} = \mathbf{X'X}^{-1} \cdot \mathbf{X'y}
$$

```{r}
b = solve(XX) %*% Xy
print(b)
```

We see that this involves matrix inversion.
Since this is a 2x2 matrix, we could do it by hand (for fun! But don't worry: R will take care of matrix inversion for this and -much- larger matrices).

$$
\begin{bmatrix}
a & b \\
c & d
\end{bmatrix} ^ {-1} = \frac{1}{ad-bc} \cdot
\begin{bmatrix}
d & -b \\
-c & a
\end{bmatrix}
$$

```{r}
print(XX)
```

```{r}
multiplicative_factor = 1/(50*25 - 25*25)
M = matrix(c(25, -25, -25, 50), nrow=2, byrow = TRUE)
print(M)
```

```{r}
invMatrix = multiplicative_factor * M
print(invMatrix)
```

```{r}
print(solve(XX))
```

#### And the p-value?

First, we need to estimate the variance of our target variable:

$$
\hat{\sigma}^2 = \frac{1}{(n-2)}\sum(y_i-\hat{y}_i)^2
$$

The $(n-2)$ comes from $(n - (k+1)$, where $k$ is the length of the vector of parameters $\mathbf{b}$ - 1 (to remove the intercept)
(we typically look at parameters one by one)

```{r}
n = nrow(temp) ## sample size
y_hat = X %*% b ## predictions/fitted values
variance = sum(residuals^2)/(n-2)
print(variance)
```

$$
\text{Var}(\hat{\beta}) = \frac{\hat{\sigma}^2}{\sum(x_i-\overline{x})^2}
$$

```{r}
x_avg = mean(X[,2])
var_beta = variance/sum((X[,2]-x_avg)^2)
```

Now, the standard error of the estimate is the square root of its variance:

```{r}
std_err_beta = sqrt(var_beta)
print(std_err_beta)
```

You can compare this with the results from the `lm()` *R* function:

```{r}
summary(fit)
```

```{r}
tstat = b[2]/std_err_beta
df = n - length(b) ## degrees of freedom
pval = 2*pt(tstat, df = df, lower.tail = TRUE)
print(pval) ## by default a two-tailed test is performed
```

